<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Most Reviews{% endblock %}</title>
  <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TBVJN61R8T"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-TBVJN61R8T', { 'anonymize_ip': true });
  </script>

  <!-- Global stylesheet -->
  <link rel="stylesheet" href="/static/css/styles.css?v=2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>

  {% include "partials/header.html" %}

  <main>
    {% block content %}{% endblock %}
  </main>

  {% include "partials/footer.html" %}

  <!-- Backdrop for mobile drawer -->
  <div class="nav-backdrop" aria-hidden="true"></div>

  <!-- Sticky Scroll + Active Nav Script -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const path = window.location.pathname;
      const shouldRunScript =
        path.includes("/partners/index.html") ||
        path.includes("/partners/by-year.html") ||
        path.includes("/hollyco/index.html") ||
        path.includes("/hollyco/seller/");

      if (!shouldRunScript) return;

      const navLinks = document.querySelectorAll(".az-nav a, .persistent-nav a");
      const sections = [];

      navLinks.forEach(link => {
        const id = link.getAttribute("href")?.replace("#", "");
        if (!id) return;
        const section = document.getElementById(id);
        if (section) {
          sections.push({ id, section });
        }
      });

      function getOffsetBuffer() {
        if (window.innerWidth <= 480) return 260;
        if (window.innerWidth <= 768) return 200;
        return 160;
      }

      function updateActiveNav() {
        let currentId = null;
        const scrollPosition = window.scrollY + getOffsetBuffer();

        sections.forEach(({ id, section }) => {
          if (section.offsetTop <= scrollPosition) {
            currentId = id;
          }
        });

        navLinks.forEach(link => {
          link.classList.remove("active");
          if (link.getAttribute("href") === `#${currentId}`) {
            link.classList.add("active");
          }
        });
      }

      window.addEventListener("scroll", updateActiveNav);
      updateActiveNav();

      // Optional: smooth scroll when page loads with hash
      if (window.location.hash) {
        const target = document.querySelector(window.location.hash);
        if (target) {
          setTimeout(() => {
            target.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 200);
        }
      }
    });
  </script>

  <!-- Global site JS -->
  <script src="/static/js/site.js"></script>

  <!-- Inline fallback for burger/drawer -->
  <script>
    (function(){
      const btn = document.querySelector('[data-mobile-menu-toggle="menu"]');
      const drawer = document.getElementById('menu');
      const backdrop = document.querySelector('.nav-backdrop');
      const closeBtn = drawer ? drawer.querySelector('.drawer-close') : null;

      if(!btn || !drawer) return;

      function openNav(){
        btn.setAttribute('aria-expanded','true');
        drawer.hidden = false;
        document.body.classList.add('nav-open','no-scroll');
      }
      function closeNav(){
        btn.setAttribute('aria-expanded','false');
        document.body.classList.remove('nav-open','no-scroll');
        setTimeout(()=>{ drawer.hidden = true; }, 250);
      }
      function toggle(e){
        e?.preventDefault();
        (btn.getAttribute('aria-expanded')==='true') ? closeNav() : openNav();
      }

      btn.addEventListener('click', toggle);
      backdrop && backdrop.addEventListener('click', closeNav);
      closeBtn && closeBtn.addEventListener('click', closeNav);
      document.addEventListener('keydown', e => {
        if(e.key==='Escape' && btn.getAttribute('aria-expanded')==='true') closeNav();
      });
      drawer.addEventListener('click', e => { if(e.target.closest('a')) closeNav(); });
    })();
  </script>

  <!-- Affiliate â†’ plain URL swap on mobile -->
  <script>
    (function() {
      var isMobile = /Mobi|Android/i.test(navigator.userAgent);
      if (isMobile) {
        document.addEventListener("DOMContentLoaded", function () {
          document.querySelectorAll('[data-product-url]').forEach(function(card) {
            var plainUrl = card.getAttribute('data-product-url');
            if (plainUrl) {
              card.setAttribute('href', plainUrl);
            }
          });
        });
      }
    })();
  </script>

  <!-- NOTHS search script (runs on all NOTHS pages, disabled on Holly pages) -->
  <script>
    const path = window.location.pathname;
    if (path.includes("/noths/") && !path.includes("/hollyco/")) {
      async function loadSellers() {
        const res = await fetch("/data/partners_search.json");
        return res.json();
      }

      loadSellers().then(partners => {
        const input = document.getElementById("sellerSearch");
        const results = document.getElementById("searchResults");
        if (!input || !results) return;

        function showMatches(q) {
          results.innerHTML = "";

          if (!q) {
            results.classList.remove("has-results");
            return;
          }

          let matches = partners
            .filter(s => s.name.toLowerCase().includes(q.toLowerCase()))
            .slice(0, 10);

          if (matches.length > 0) {
            results.classList.add("has-results");
            matches.forEach(s => {
              let li = document.createElement("li");
              li.innerHTML = `<a href="/noths/partners/${s.slug[0]}/${s.slug}.html">${s.name}</a>`;
              results.appendChild(li);
            });
          } else {
            results.classList.remove("has-results");
          }

          return matches;
        }

        input.addEventListener("input", () => {
          showMatches(input.value);
        });

        input.addEventListener("keydown", e => {
          if (e.key === "Enter") {
            let matches = showMatches(input.value);
            if (matches && matches.length > 0) {
              window.location.href = `/noths/partners/${matches[0].slug[0]}/${matches[0].slug}.html`;
            }
          }
        });
      });
    }
  </script>

</body>
</html>
